---
title: "Covid by County: Interactive Map"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: 
      version: 4
      bootswatch: lux
runtime: shiny
---
  
```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(leaflet)
library(dplyr)
library(tigris)
library(sf)
library(glue)
library(stringr)
options(tigris_use_cache = TRUE)

covid_demo_final_df <- readRDS("covid_demo_final_df.rds")

covid_demo_final_df <- covid_demo_final_df |>
  mutate(
    majority_2016 = case_when(
      elections_2016_dem > elections_2016_gop ~ "Democrat",
      elections_2016_gop > elections_2016_dem ~ "Republican",
      TRUE ~ "Tie"
    ),
    majority_2020 = case_when(
      elections_2020_dem > elections_2020_gop ~ "Democrat",
      elections_2020_gop > elections_2020_dem ~ "Republican",
      TRUE ~ "Tie"
    ),
    black_prop = race_black_alone_male + race_black_alone_female
  )

counties_sf <- counties(cb = TRUE, year = 2020) |>
  st_transform(4326)

# Centroids for circles to overlay on map
centroids = st_centroid(counties_sf)
counties_sf$lon = st_coordinates(centroids)[, 1]
counties_sf$lat = st_coordinates(centroids)[, 2]

counties_joined = counties_sf |>
  left_join(covid_demo_final_df, by = c("GEOID" = "fips"))

covid_rates = readRDS("covid_yearly_rates.rds") |>
  mutate(
    # making sure fips is 5 characters
    fips = as.character(fips),
    fips = str_pad(fips, 5, pad = "0"),
    # pulling NYC together, otherwise it wont appear "New York City, New York" to Manhattan's FIPS (36061)
    fips = if_else(
      (is.na(fips) | fips == "000NA") & county == "New York City" & state == "New York",
      "36061",
      fips
    )
  ) |>
  # dropping "Unknown" pseudo-counties
  filter(fips != "000NA", !grepl("^Unknown", county))

#reference point to set circle size overlay
global_max_cases  = max(covid_rates$yearly_cases,  na.rm = TRUE)
global_max_deaths = max(covid_rates$yearly_deaths, na.rm = TRUE)

```

Column {.sidebar}
-------------------------------------

### Compare Groups Across Time

```{r}
selectInput(
  inputId = "compare_type",
  label   = "Choose What to Compare:",
  choices = c(
    "Poverty (High vs Low)"                           = "poverty",
    "Proportion black population (high vs low)"       = "race_black",
    "Political Party Majority (republican vs democrat)" = "party"
  )
)

conditionalPanel(
  condition = "input.compare_type == 'party'",
  radioButtons(
    inputId = "election_year",
    label = "Election Year:",
    choices = c("2016", "2020"),
    selected = "2020"
  )
)

sliderInput(
  inputId = "year",
  label   = "COVID Year:",
  min     = 2020,
  max     = 2023,
  value   = 2020,
  step    = 1,
  sep     = ""
)

radioButtons(
  inputId = "covid_metric",
  label   = "COVID Metric (raw counts):",
  choices = c("Cases" = "cases", "Deaths" = "deaths"),
  selected = "cases"
)
```

Column
-------------------------------------

### High Poverty / Larger Black Population / Republican Majority

```{r}
renderLeaflet({

  df <- counties_joined

  # Bring in covid raw yearly counts for selected year
  covid_year <- covid_rates |>
    filter(year == input$year)

  df <- df |>
    left_join(covid_year, by = c("GEOID" = "fips"))

  # Choose raw count column based on metric
  value_col <- if (input$covid_metric == "cases") "yearly_cases" else "yearly_deaths"
  metric_label <- if (input$covid_metric == "cases") "Yearly Cases" else "Yearly Deaths"

  # scale for circle size
  global_max <- if (value_col == "yearly_cases") global_max_cases else global_max_deaths

  if (input$compare_type == "poverty") {

    high_df <- df |> filter(poverty_rate > 15)

    high_df <- high_df |>
      mutate(
        covid_raw = .data[[value_col]],
        radius = if_else(
          is.na(covid_raw) | covid_raw <= 0,
          0,
          4 + 20 * sqrt(covid_raw / global_max)  # bigger & relative to yearly max
        )
      )

    leaflet(high_df) |>
      setView(lng = -98.5795, lat = 39.8283, zoom = 4) |> 
      addProviderTiles("CartoDB.Positron") |>
      addPolygons(
        fillColor   = "darkred",
        fillOpacity = 0.7,
        color       = "white",
        weight      = 1,
        popup = high_df |>
          mutate(
            popup = glue("<strong>{NAME} County</strong><br>Poverty rate: {poverty_rate}")
          ) |>
          pull(popup)
      ) |>
      
      #create circle markers to overlay
      addCircleMarkers(
        data   = high_df |> filter(radius > 0),
        lng    = ~lon,
        lat    = ~lat,
        radius = ~radius,
        stroke = FALSE,
        fillOpacity = 0.6,
        fillColor   = "orange",
        popup = ~glue(
          "<strong>{NAME} County</strong><br>",
          "{metric_label}: {covid_raw}<br>",
          "Year: {input$year}"
        )
      )

  } else if (input$compare_type == "race_black") {

    cutoff <- quantile(df$black_prop, 0.75, na.rm = TRUE)
    high_df <- df |> filter(black_prop >= cutoff)

    high_df <- high_df |>
      mutate(
        covid_raw = .data[[value_col]],
        radius = if_else(
          is.na(covid_raw) | covid_raw <= 0,
          0,
          4 + 20 * sqrt(covid_raw / global_max)
        )
      )

    leaflet(high_df) |>
      setView(lng = -98.5795, lat = 39.8283, zoom = 4) |> 
      addProviderTiles("CartoDB.Positron") |>
      addPolygons(
        fillColor   = "purple",
        fillOpacity = 0.7,
        color       = "white",
        weight      = 1,
        popup = high_df |>
          mutate(
            popup = glue("<strong>{NAME} County, {STATEFP}</strong><br>Black population share: {round(black_prop, 3)}")
          ) |>
          pull(popup)
      ) |>
      
      #create circle markers to overlay
      addCircleMarkers(
        data = high_df |> filter(radius > 0),
        lng = ~lon, lat = ~lat, radius = ~radius,
        stroke = FALSE, fillOpacity = 0.6, fillColor = "orange",
        popup = ~glue(
          "<strong>{NAME} County</strong><br>",
          "{metric_label}: {covid_raw}<br>",
          "Year: {input$year}"
        )
      )

  } else {

    maj_col <- if (input$election_year == "2016") "majority_2016" else "majority_2020"
    high_df <- df |> filter(.data[[maj_col]] == "Republican")

    high_df <- high_df |>
      mutate(
        covid_raw = .data[[value_col]],
        radius = if_else(
          is.na(covid_raw) | covid_raw <= 0,
          0,
          4 + 20 * sqrt(covid_raw / global_max)
        )
      )

    leaflet(high_df) |>
      setView(lng = -98.5795, lat = 39.8283, zoom = 4) |> 
      addProviderTiles("CartoDB.Positron") |>
      addPolygons(
        fillColor   = "red",
        fillOpacity = 0.7,
        color       = "white",
        weight      = 1,
        popup = high_df |>
          mutate(
            popup = glue("<strong>{NAME} County</strong><br>Majority: Republican ({input$election_year})")
          ) |>
          pull(popup)
      ) |>
      
      #create circle markers to overlay
      addCircleMarkers(
        data = high_df |> filter(radius > 0),
        lng = ~lon, lat = ~lat, radius = ~radius,
        stroke = FALSE, fillOpacity = 0.6, fillColor = "orange",
        popup = ~glue(
          "<strong>{NAME} County</strong><br>",
          "{metric_label}: {covid_raw}<br>",
          "Year: {input$year}"
        )
      )
  }

})
```

Column
-------------------------------------

### Low Poverty / Smaller Black Population / Democratic Majority

```{r}
renderLeaflet({

  df <- counties_joined

  # Bring in covid raw yearly counts for selected year
  covid_year <- covid_rates |>
    filter(year == input$year)

  df <- df |>
    left_join(covid_year, by = c("GEOID" = "fips"))

  value_col <- if (input$covid_metric == "cases") "yearly_cases" else "yearly_deaths"
  metric_label <- if (input$covid_metric == "cases") "Yearly Cases" else "Yearly Deaths"

  #scale for circle size
  global_max <- if (value_col == "yearly_cases") global_max_cases else global_max_deaths

  if (input$compare_type == "poverty") {

    low_df <- df |> filter(poverty_rate <= 15)

    low_df <- low_df |>
      mutate(
        covid_raw = .data[[value_col]],
        radius = if_else(
          is.na(covid_raw) | covid_raw <= 0,
          0,
          4 + 20 * sqrt(covid_raw / global_max)
        )
      )

    leaflet(low_df) |>
      setView(lng = -98.5795, lat = 39.8283, zoom = 4) |> 
      addProviderTiles("CartoDB.Positron") |>
      addPolygons(
        fillColor = "darkgreen", fillOpacity = 0.7,
        color = "white", weight = 1,
        popup = low_df |> mutate(
          popup = glue("<strong>{NAME} County</strong><br>Poverty rate: {poverty_rate}")
        ) |> pull(popup)
      ) |>
      
      #create circle markers to overlay
      addCircleMarkers(
        data = low_df |> filter(radius > 0),
        lng = ~lon, lat = ~lat, radius = ~radius,
        stroke = FALSE, fillOpacity = 0.6, fillColor = "orange",
        popup = ~glue(
          "<strong>{NAME} County</strong><br>",
          "{metric_label}: {covid_raw}<br>",
          "Year: {input$year}"
        )
      )

  } else if (input$compare_type == "race_black") {

    cutoff <- quantile(df$black_prop, 0.75, na.rm = TRUE)
    low_df <- df |> filter(black_prop < cutoff)

    low_df <- low_df |>
      mutate(
        covid_raw = .data[[value_col]],
        radius = if_else(
          is.na(covid_raw) | covid_raw <= 0,
          0,
          4 + 20 * sqrt(covid_raw / global_max)
        )
      )

    leaflet(low_df) |>
      setView(lng = -98.5795, lat = 39.8283, zoom = 4) |> 
      addProviderTiles("CartoDB.Positron") |>
      addPolygons(
        fillColor = "lightblue", fillOpacity = 0.7,
        color = "white", weight = 1,
        popup = low_df |> mutate(
          popup = glue("<strong>{NAME} County</strong><br>Black population share: {round(black_prop,3)}")
        ) |> pull(popup)
      ) |>
      
      #create circle markers to overlay
      addCircleMarkers(
        data = low_df |> filter(radius > 0),
        lng = ~lon, lat = ~lat, radius = ~radius,
        stroke = FALSE, fillOpacity = 0.6, fillColor = "orange",
        popup = ~glue(
          "<strong>{NAME} County</strong><br>",
          "{metric_label}: {covid_raw}<br>",
          "Year: {input$year}"
        )
      )

  } else {

    maj_col <- if (input$election_year == "2016") "majority_2016" else "majority_2020"
    low_df <- df |> filter(.data[[maj_col]] == "Democrat")

    low_df <- low_df |>
      mutate(
        covid_raw = .data[[value_col]],
        radius = if_else(
          is.na(covid_raw) | covid_raw <= 0,
          0,
          4 + 20 * sqrt(covid_raw / global_max)
        )
      )

    leaflet(low_df) |>
      setView(lng = -98.5795, lat = 39.8283, zoom = 4) |> 
      addProviderTiles("CartoDB.Positron") |>
      addPolygons(
        fillColor = "blue", fillOpacity = 0.7,
        color = "white", weight = 1,
        popup = low_df |> mutate(
          popup = glue("<strong>{NAME} County</strong><br>Majority: Democrat ({input$election_year})")
        ) |> pull(popup)
      ) |>
      
      #create circle markers to overlay
      addCircleMarkers(
        data = low_df |> filter(radius > 0),
        lng = ~lon, lat = ~lat, radius = ~radius,
        stroke = FALSE, fillOpacity = 0.6, fillColor = "orange",
        popup = ~glue(
          "<strong>{NAME} County</strong><br>",
          "{metric_label}: {covid_raw}<br>",
          "Year: {input$year}"
        )
      )
  }

})

```
